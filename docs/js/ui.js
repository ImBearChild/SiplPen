"use strict";ZenPen=window.ZenPen||{};ZenPen.ui=function(){var body,article,uiContainer,overlay,header;var screenSizeElement,colorLayoutElement,targetElement,saveElement;var wordCountValue,wordCountBox,wordCountElement,wordCounterProgress,counterBar;var counterBarUse=0;var supportsSave,saveFormat,textToWrite,saveModal;var expandScreenIcon='<i class="fa fa-arrows-alt fa-fw" aria-hidden="true"></i>';var shrinkScreenIcon='<i class="fa fa-compress fa-fw" aria-hidden="true"></i>';var darkLayout=false;var flowstateMode=false;var strictFlow=false;var flowstateBox,flowstateFailBox,timeCounterProgress,flowingBox;var total_set,expiring_set,total_time,expiring_time,total_id,expiring_id,alpha_step;var timeCounterProgress;var settingBox,infoBox,fontProgress;function init(){supportsSave=!!new Blob?true:false;bindElements();loadSettingItems();var wordCountActive=false;if(ZenPen.util.supportsHtmlStorage()){loadState()}}function loadState(){if(localStorage["wordCount"]&&localStorage["wordCount"]!=="0"){wordCountValue=parseInt(localStorage["wordCount"]);wordCountElement.value=localStorage["wordCount"];setWordCount(parseInt(localStorage["wordCount"]));updateWordCount()}if(localStorage["darkLayout"]==="true"){if(darkLayout===false){document.body.className="yang"}else{document.body.className="yin"}darkLayout=!darkLayout}}function saveState(){if(ZenPen.util.supportsHtmlStorage()){localStorage["darkLayout"]=darkLayout;localStorage["wordCount"]=wordCountElement.value}}function bindElements(){body=document.body;uiContainer=document.querySelector(".ui");colorLayoutElement=document.querySelector(".color-flip");colorLayoutElement.onclick=onColorLayoutClick;screenSizeElement=document.querySelector(".fullscreen");screenSizeElement.onclick=onScreenSizeClick;targetElement=document.querySelector(".target ");targetElement.onclick=onTargetClick;targetElement=document.querySelector(".infobtn ");targetElement.onclick=onInfoClick;targetElement=document.querySelector(".settingbtn ");targetElement.onclick=onSettingsClick;targetElement=document.querySelector(".flowstate ");targetElement.onclick=onFlowstateClick;targetElement=document.querySelector(".startflow");targetElement.onclick=function(){total_set=document.getElementsByName("total_time")[0].value*60;expiring_set=document.getElementsByName("expiring_time")[0].value*10;total_time=total_set;expiring_time=expiring_set;alpha_step=1/expiring_time;enterFlowstateMode();removeOverlay()};if(supportsSave){saveElement=document.querySelector(".save");saveElement.onclick=onSaveClick;var formatSelectors=document.querySelectorAll(".saveselection span");for(var i in formatSelectors){try{formatSelectors[i].onclick=selectFormat}catch(error){console.log(error)}}document.querySelector(".savebutton").onclick=saveText}else{document.querySelector(".save.useicons").style.display="none"}overlay=document.querySelector(".overlay");overlay.onclick=onOverlayClick;article=document.querySelector(".content");article.onkeyup=onArticleKeyUp;wordCountBox=overlay.querySelector(".wordcount");wordCountElement=wordCountBox.querySelector("input");wordCountElement.onchange=onWordCountChange;wordCountElement.onkeyup=onWordCountKeyUp;saveModal=overlay.querySelector(".saveoverlay");counterBar=document.querySelector(".counter-bar");wordCounterProgress=counterBar.querySelector(".word-progress");flowstateBox=overlay.querySelector(".flowsettings");flowstateFailBox=overlay.querySelector(".flowfailure");timeCounterProgress=counterBar.querySelector(".time-progress");flowingBox=overlay.querySelector(".flowing");settingBox=overlay.querySelector(".settings");infoBox=overlay.querySelector(".info");fontProgress=counterBar.querySelector(".font-progress");header=document.querySelector(".header");header.onkeypress=onHeaderKeyPress}function onScreenSizeClick(event){screenfull.toggle();if(screenfull.enabled){document.addEventListener(screenfull.raw.fullscreenchange,function(){if(screenfull.isFullscreen){screenSizeElement.innerHTML=shrinkScreenIcon}else{screenSizeElement.innerHTML=expandScreenIcon}})}}function onColorLayoutClick(event){if(darkLayout===false){document.body.className="yang"}else{document.body.className="yin"}darkLayout=!darkLayout;saveState()}function onTargetClick(event){ZenPen.util.fadeIn(overlay);ZenPen.util.fadeIn(wordCountBox);wordCountElement.focus()}function onSaveClick(event){ZenPen.util.fadeIn(overlay);ZenPen.util.fadeIn(saveModal)}function onInfoClick(event){var t=document.getElementById("wordcountinfo");t.innerText=ZenPen.editor.getWordCount();ZenPen.util.fadeIn(overlay);ZenPen.util.fadeIn(infoBox)}function onSettingsClick(event){checkSettingItems();ZenPen.util.fadeIn(overlay);ZenPen.util.fadeIn(settingBox)}function onFlowstateClick(event){if(flowstateMode===false){ZenPen.util.fadeIn(overlay);ZenPen.util.fadeIn(flowstateBox)}else{ZenPen.util.fadeIn(overlay);ZenPen.util.fadeIn(flowingBox)}darkLayout=!darkLayout}function saveText(event){if(typeof saveFormat!="undefined"&&saveFormat!=""){var blob=new Blob([textToWrite],{type:"text/plain;charset=utf-8"});var headerText=header.innerHTML.replace(/(\t|\n|\r)/gm,"");if(headerText===""){headerText="ZenPen"}saveAs(blob,headerText+".txt")}else{document.querySelector(".saveoverlay h1").style.color="#FC1E1E"}}function onHeaderKeyPress(event){if(event.keyCode===13){event.preventDefault();article.focus()}}function onWordCountKeyUp(event){if(event.keyCode===13){event.preventDefault();setWordCount(parseInt(this.value));removeOverlay();article.focus()}}function onWordCountChange(event){setWordCount(parseInt(this.value))}function claimCount(){counterBarUse+=1;counterBar.className="counter-bar active"}function unclaimCount(){counterBarUse-=1;if(counterBarUse<=0){counterBar.className="counter-bar"}}function setWordCount(count){if(count>0){wordCountValue=count;claimCount();updateWordCount()}else{wordCountValue=0;wordCounterProgress.style.width=0;unclaimCount()}saveState()}function onArticleKeyUp(event){if(wordCountValue>0){updateWordCount()}}function updateWordCount(){var wordCount=ZenPen.editor.getWordCount();var percentageComplete=wordCount/wordCountValue;wordCounterProgress.style.width=percentageComplete*100+"%";if(percentageComplete>=1){wordCounterProgress.className="word-progress progress complete"}else{wordCounterProgress.className="word-progress progress"}}function selectFormat(e){if(document.querySelectorAll("span.activesave").length>0){document.querySelector("span.activesave").className=""}document.querySelector(".saveoverlay h1").style.cssText="";var targ;if(!e)var e=window.event;if(e.target)targ=e.target;else if(e.srcElement)targ=e.srcElement;if(targ.nodeType==3){targ=targ.parentNode}targ.className="activesave";saveFormat=targ.getAttribute("data-format");var header=document.querySelector("header.header");var headerText=header.innerHTML.replace(/(\r\n|\n|\r)/gm,"")+"\n";var body=document.querySelector("article.content");var bodyText=body.innerHTML;textToWrite=formatText(saveFormat,headerText,bodyText);var textArea=document.querySelector(".hiddentextbox");textArea.value=textToWrite;textArea.focus();textArea.select()}function formatText(type,header,body){var text;switch(type){case"html":header="<h1>"+header+"</h1>";text=header+body;text=text.replace(/\t/g,"");break;case"markdown":header=header.replace(/\t/g,"");header=header.replace(/\n$/,"");header="#"+header+"#";text=body.replace(/\t/g,"");text=text.replace(/<b>|<\/b>/g,"**").replace(/\r\n+|\r+|\n+|\t+/gi,"").replace(/<i>|<\/i>/g,"_").replace(/<blockquote>/g,"> ").replace(/<\/blockquote>/g,"").replace(/<p>|<\/p>/gi,"\n").replace(/<br>/g,"\n");var links=text.match(/<a href="(.+)">(.+)<\/a>/gi);if(links!==null){for(var i=0;i<links.length;i++){var tmpparent=document.createElement("div");tmpparent.innerHTML=links[i];var tmp=tmpparent.firstChild;var href=tmp.getAttribute("href");var linktext=tmp.textContent||tmp.innerText||"";text=text.replace(links[i],"["+linktext+"]("+href+")")}}text=header+"\n\n"+text;break;case"plain":header=header.replace(/\t/g,"");var tmp=document.createElement("div");tmp.innerHTML=body;text=tmp.textContent||tmp.innerText||"";text=text.replace(/\t/g,"").replace(/\n{3}/g,"\n").replace(/\n/,"");text=header+text;break;default:break}return text}function onOverlayClick(event){if(event.target.className==="overlay"){removeOverlay()}}function removeOverlay(){ZenPen.util.fadeOut(overlay);setTimeout(function(){var childs=overlay.getElementsByClassName("modal");for(var i=childs.length-1;i>=0;i--){childs[i].style.display="none"}document.querySelector(".finishsummary ").style.display="none"},500);if(document.querySelectorAll("span.activesave").length>0){document.querySelector("span.activesave").className=""}saveFormat=""}function disableCopy(){window.oncontextmenu=function(e){e.preventDefault()};document.body.oncopy=function(){return false}}function enterFlowstateMode(){if(strictFlow===true){console.log("Strict Flowmode");disableCopy()}console.log("Starting flowstate mode: "+total_time+" , "+expiring_time+" , "+alpha_step);resetOpacity();targetElement=document.querySelector(".content");targetElement.oninput=function(){console.log("Press!");expiring_time=expiring_set;resetOpacity()};total_id=setInterval(count_total_down,1e3);expiring_id=setInterval(count_exp_down,100);flowstateMode=true;claimCount();timeCounterProgress.style.transition="width "+total_set+"s";timeCounterProgress.style.transitionTimingFunction="linear";timeCounterProgress.style.width="100%"}function count_total_down(){if(total_time>0){total_time=total_time-1}else{console.log("All over");flowCompleted()}}function count_exp_down(){if(expiring_time>0){expiring_time=expiring_time-1;document.getElementsByClassName("content")[0].style.opacity=document.getElementsByClassName("content")[0].style.opacity-alpha_step}else{console.log("Over");ZenPen.editor.cls();flowCleanWork();ZenPen.util.fadeIn(overlay);ZenPen.util.fadeIn(flowstateFailBox)}}function resetOpacity(){document.getElementsByClassName("content")[0].style.opacity=1}function flowCleanWork(){clearInterval(total_id);clearInterval(expiring_id);resetOpacity();unclaimCount();timeCounterProgress.style.transition="";timeCounterProgress.style.width="0px";flowstateMode=false}function flowCompleted(){flowCleanWork();ZenPen.util.fadeIn(overlay);ZenPen.util.fadeIn(saveModal);targetElement=document.querySelector(".finishsummary ");targetElement.innerHTML=targetElement.innerHTML.replace("{s}",total_set/60);targetElement.style.display="block"}function loadSettingItems(){if(localStorage.getItem("src_font")===null){localStorage.setItem("src_font","No")}if(localStorage.getItem("src_font")==="Yes"){document.querySelector("body").classList.add("src-font")}else if(localStorage.getItem("src_font")==="No"){document.querySelector("body").classList.remove("src-font")}if(localStorage.getItem("strict_flow")===null){localStorage.setItem("strict_flow","No")}if(localStorage.getItem("strict_flow")==="Yes"){strictFlow=true}else if(localStorage.getItem("strict_flow")==="No"){strictFlow=false}}function checkSettingItems(){if(window.location.search.indexOf("lang=")!=-1){document.getElementById("langarginform").style.display="block"}if(localStorage.getItem("src_font")==="Yes"){document.querySelector("#toggleFont i").className="fa fa-fw fa-check-square-o"}else if(localStorage.getItem("src_font")==="No"){document.querySelector("#toggleFont i").className="fa fa-fw fa-square-o"}else{document.querySelector("#toggleFont i").className="fa fa-fw fa-exclamation-triangle"}if(localStorage.getItem("strict_flow")==="Yes"){document.querySelector("#toggleStrict i").className="fa fa-fw fa-check-square-o"}else if(localStorage.getItem("strict_flow")==="No"){document.querySelector("#toggleStrict i").className="fa fa-fw fa-square-o"}else{document.querySelector("#toggleStrict i").className="fa fa-fw fa-exclamation-triangle"}}function s_toggleStrict(){if(localStorage.getItem("strict_flow")==="Yes"){localStorage.setItem("strict_flow","No");strictFlow=false}else if(localStorage.getItem("strict_flow")==="No"){localStorage.setItem("strict_flow","Yes");strictFlow=true}else{alert(alertContent1)}checkSettingItems()}function s_cleanLocalStorage(){if(confirm(confirmContent1)===true){localStorage.clear();window.location.reload()}}function s_toggleFont(){if(localStorage.getItem("src_font")==="No"){document.querySelector("body").classList.add("src-font");localStorage.setItem("src_font","Yes");var a=setTimeout(function(){document.getElementById("spanfontloading").style.display="inline"},5e3);claimCount();var t=0;if(t===0){fontProgress.style.marginLeft=window.innerWidth+"px";t=1}else{fontProgress.style.marginLeft="-33px";t=0}var pid=setInterval(function(){if(t===0){fontProgress.style.marginLeft=window.innerWidth+"px";t=1}else{fontProgress.style.marginLeft="-33px";t=0}},5e3);var font=new FontFaceObserver("SourceHanSerifWeb");font.load(null,1e5).then(function(){clearInterval(pid);clearTimeout(a);unclaimCount();console.log("Font is available")},function(){unclaimCount();setTimeout(function(){document.getElementById("spanfontloading").style.display="none"},3e3);console.log("Font is not available");clearInterval(pid);clearTimeout(a)})}else if(localStorage.getItem("src_font")==="Yes"){localStorage.setItem("src_font","No");document.querySelector("body").classList.remove("src-font")}else{alert(alertContent1)}checkSettingItems()}return{init:init,flowCompleted:flowCompleted,unclaimCount:unclaimCount,s_cleanLocalStorage:s_cleanLocalStorage,s_toggleFont:s_toggleFont,s_toggleStrict:s_toggleStrict}}();