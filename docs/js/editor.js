ZenPen=window.ZenPen||{};ZenPen.editor=function(){var headerField,contentField,lastType,currentNodeList,lastSelection;var textOptions,optionsBox,boldButton,italicButton,quoteButton,urlButton,urlInput;var composing;function init(){composing=false;bindElements();createEventBindings();if(ZenPen.util.supportsHtmlStorage()){loadState()}else{loadDefault()}var range=document.createRange();var selection=window.getSelection();range.setStart(headerField,1);selection.removeAllRanges();selection.addRange(range);if("ontouchstart"in window){optionsBox.classList.add("options-mobile")}}function createEventBindings(){if(ZenPen.util.supportsHtmlStorage()){document.onkeyup=function(event){saveState();checkTextHighlighting(event)}}else{document.onkeyup=checkTextHighlighting}document.onmousedown=checkTextHighlighting;document.onmouseup=function(event){setTimeout(function(){checkTextHighlighting(event)},1)};document.oncontextmenu=function(event){setTimeout(function(){checkTextHighlighting(event)},1)};window.addEventListener("resize",function(event){updateBubblePosition()});document.body.addEventListener("scroll",function(){updateBubblePosition()});document.addEventListener("compositionstart",onCompositionStart);document.addEventListener("compositionend",onCompositionEnd)}function bindElements(){headerField=document.querySelector(".header");contentField=document.querySelector(".content");textOptions=document.querySelector(".text-options");optionsBox=textOptions.querySelector(".options");boldButton=textOptions.querySelector(".bold");boldButton.onclick=onBoldClick;italicButton=textOptions.querySelector(".italic");italicButton.onclick=onItalicClick;quoteButton=textOptions.querySelector(".quote");quoteButton.onclick=onQuoteClick;urlButton=textOptions.querySelector(".url");urlButton.onmousedown=onUrlClick;urlInput=textOptions.querySelector(".url-input");urlInput.onblur=onUrlInputBlur;urlInput.onkeydown=onUrlInputKeyDown}function checkTextHighlighting(event){var selection=window.getSelection();if(event.target.className==="url-input"||event.target.classList.contains("url")||event.target.parentNode.classList.contains("ui-inputs")){currentNodeList=findNodes(selection.focusNode);updateBubbleStates();return}if(selection.isCollapsed===true&&lastType===false){onSelectorBlur()}if(selection.isCollapsed===false&&composing===false){currentNodeList=findNodes(selection.focusNode);if(hasNode(currentNodeList,"ARTICLE")){updateBubbleStates();updateBubblePosition();textOptions.className="text-options active"}}lastType=selection.isCollapsed}function updateBubblePosition(){var selection=window.getSelection();var range=selection.getRangeAt(0);var boundary=range.getBoundingClientRect();if("ontouchstart"in window){textOptions.style.top=boundary.bottom+64+window.pageYOffset+"px";textOptions.style.left=(boundary.left+boundary.right)/2+"px"}else{textOptions.style.top=boundary.top-5+window.pageYOffset+"px";textOptions.style.left=(boundary.left+boundary.right)/2+"px"}}function updateBubbleStates(){if(hasNode(currentNodeList,"B")){boldButton.className="bold active"}else{boldButton.className="bold"}if(hasNode(currentNodeList,"I")){italicButton.className="italic active"}else{italicButton.className="italic"}if(hasNode(currentNodeList,"BLOCKQUOTE")){quoteButton.className="quote active"}else{quoteButton.className="quote"}if(hasNode(currentNodeList,"A")){urlButton.className="url active"}else{urlButton.className="url"}}function onSelectorBlur(){textOptions.className="text-options fade";setTimeout(function(){if(textOptions.className=="text-options fade"){textOptions.className="text-options";textOptions.style.top="-999px";textOptions.style.left="-999px"}},260)}function findNodes(element){var nodeNames={};var selection=window.getSelection();while(element.parentNode){nodeNames[element.nodeName]=true;element=element.parentNode;if(element.nodeName==="A"){nodeNames.url=element.href}}return nodeNames}function hasNode(nodeList,name){return!!nodeList[name]}function saveState(event){localStorage["header"]=headerField.innerHTML;localStorage["content"]=contentField.innerHTML}function loadState(){if(localStorage["header"]){headerField.innerHTML=localStorage["header"]}else{headerField.innerHTML=defaultTitle}if(localStorage["content"]){contentField.innerHTML=localStorage["content"]}else{loadDefaultContent()}}function loadDefault(){headerField.innerHTML=defaultTitle;loadDefaultContent()}function loadDefaultContent(){if(tran.getLang()==="cn"){contentField.innerHTML=defaultContentCN}else{contentField.innerHTML=defaultContent}}function onBoldClick(){document.execCommand("bold",false)}function onItalicClick(){document.execCommand("italic",false)}function onQuoteClick(){var nodeNames=findNodes(window.getSelection().focusNode);if(hasNode(nodeNames,"BLOCKQUOTE")){document.execCommand("formatBlock",false,"p");document.execCommand("outdent")}else{document.execCommand("formatBlock",false,"blockquote")}}function onUrlClick(){if(optionsBox.className=="options"){optionsBox.className="options url-mode";setTimeout(function(){var nodeNames=findNodes(window.getSelection().focusNode);if(hasNode(nodeNames,"A")){urlInput.value=nodeNames.url}else{document.execCommand("createLink",false,"/")}lastSelection=window.getSelection().getRangeAt(0);lastType=false;urlInput.focus()},100)}else if(optionsBox.className=="options options-mobile"){lastSelection=window.getSelection().getRangeAt(0);word=prompt("URL:","");window.getSelection();applyURL(word)}else{if("ontouchstart"in window){optionsBox.className="options options-mobile"}else{optionsBox.className="options "}}}function onUrlInputKeyDown(event){if(event.keyCode===13){event.preventDefault();applyURL(urlInput.value);urlInput.blur()}}function onUrlInputBlur(event){optionsBox.className="options";applyURL(urlInput.value);urlInput.value="";currentNodeList=findNodes(window.getSelection().focusNode);updateBubbleStates()}function applyURL(url){rehighlightLastSelection();document.execCommand("unlink",false);if(url!==""){if(!url.match("^(http|https)://")){url="http://"+url}document.execCommand("createLink",false,url)}}function rehighlightLastSelection(){var selection=window.getSelection();if(selection.rangeCount>0){selection.removeAllRanges()}selection.addRange(lastSelection)}function getWordCount(){var text=ZenPen.util.getText(contentField);var sLen;if(text===""){return 0}else{try{str=text.replace(/(\r\n+|\s+|　+)/g,"龘");str=str.replace(/[\x00-\xff]/g,"m");str=str.replace(/m+/g,"*");str=str.replace(/龘+/g,"");sLen=str.length}catch(e){}return sLen}}function onCompositionStart(event){composing=true}function onCompositionEnd(event){composing=false}function cls(){paras=document.getElementsByClassName("content")[0];childs=paras.childNodes;for(var i=childs.length-1;i>=0;i--){paras.removeChild(childs[i])}document.getElementsByClassName("content")[0].style.opacity=1;saveState()}return{init:init,saveState:saveState,getWordCount:getWordCount,cls:cls,loadDefaultContent:loadDefaultContent}}();